from fastapi import FastAPI, UploadFile, Form
from fastapi.responses import JSONResponse
from fastapi.staticfiles import StaticFiles
from backend.database import get_connection
import subprocess, tempfile, os

app = FastAPI()

# Фронтенд на /frontend
app.mount("/frontend", StaticFiles(directory="frontend", html=True), name="frontend")

tasks = [
    {
        "id": 1,
        "title": "Сумма двух чисел | Iki ədədin cəmi",
        "description": """русский:
Вводятся два числа, выведите их сумму.
0 < a, b < 100000
Примеры:
ввод
1 2
вывод
3

azerbaycan dili:
İki ədəd verilir, onların cəmini çıxarın.
0 < a, b < 100000
Nümunələr:
Giriş
1 2
Çıxış
3""",
        "tests": [
            {"input": "2 3\n", "output": "5"},
            {"input": "10 20\n", "output": "30"},
            {"input": "10000 12121\n", "output": "22121"},
            {"input": "1 23232\n", "output": "23233"}
        ]
    },
    {
        "id": 2,
        "title": "Умножение чисел | İki ədədin vurulması",
        "description": """русский:
Вводятся два числа, выведите их произведение.
0 <= a,b <= 1000000
Примеры:
ввод
10 10
вывод
100

azerbaycan dili:
İki ədəd verilir, onların hasilini çıxarın.
0 <= a, b <= 1000000
Nümunələr:
Giriş
10 10
Çıxış
100""",
        "tests": [
            {"input": "2 3\n", "output": "6"},
            {"input": "10 20\n", "output": "200"},
            {"input": "1000000 1000000\n", "output": "1000000000000"},
            {"input": "0 1000000\n", "output": "0"},
        ]
    },
    {
        "id": 3,
        "title": "Королевские кони | Kral atları",
        "description": """
русский:
Даётся поле n*n. Вы должны вывести количество способов расставить m шахматных коней так, 
чтобы ни один конь не бил другого и кони не были поставлены рядом по горизонтали или по вертикали.
1 <= n <= 10 | 1 <= m <=n
Примеры:
ввод
3 2
вывод
16

azerbaycan dili:
n*n ölçülü sahə verilir. Siz m şahmat atını yerləşdirməyin yollarının sayını çıxarmalısınız
belə ki, heç bir at digərini vura bilməsin və atlar yan-yana
şaquli və üfüqi xətt üzrə yerləşdirilməsin.
1 <= n <= 10 | 1 <= m <= n
Nümunə:
Giriş
3 2
Çıxış
16""",
        "tests": [
            {"input": "1 1\n", "output": "1"},
            {"input": "2 1\n", "output": "4"},
            {"input": "4 2\n", "output": "72"},
            {"input": "5 5\n", "output": "2999"},
            {"input": "7 3\n", "output": "10478"},
            {"input": "8 4\n", "output": "262549"},
            {"input": "9 5\n", "output": "7807853"},
        ]
    }
    {
        "id": 4,
        "title": "Хороший массив? (Лёгкая версия) | Yaxşı massiv? (Asan versiya)",
        "description": """
русский:
Дан массив A длинной n. У вас есть следущяя операция 
которую можно применить на массиве:
Возьмите элемент Ai (3 <= i <= n) и поменяйте индекс Ai с A(i-2)
Выведете YES если можно переставить массив в возрастающем порядке
, иначе выведете NO.
1 <= n <= 1000 | -3000000000 <= Ai <= 3000000000
Примеры:
ввод
6
1 3 2 4 5 6
вывод
NO

azerbaycan dili:
Sizə uzunluğu n olan A massivi verilib.
Siz bu əməliyyatı massivə tətbiq edə bilərsiniz:
3 <= i <= n olduqda, A[i] elementini A[i-2] elementi ilə yerlərini dəyişin.
Əgər bu əməliyyatları istənilən sayda tətbiq etməklə massivi artan ardıcıllıqla düzəltmək mümkündürsə,
YES çıxarın,
əks halda NO çıxarın.
1 <= n <= 1000 | −3000000000 <= Ai <= 3000000000
Nümunə:
Giriş:
6
1 3 2 4 5 6
Çıxış:
NO
""",
        "tests": [
            {"input": """
1
1
            """, "output": "YES"},
            {"input": """
3
1 2999999999 3000000000
            """, "output": "YES"},
            {"input": """
5
5 4 3 3 5
            """, "output": "YES"},
            {"input": """
3
2 1 2
            """, "output": "NO"},
            {"input": """
200
101 1 102 2 103 3 104 4 105 5 106 6 107 7 108 8 109 9 110 10 111 11 112 12 113 13 114 14 115 15 116 16 117 17 118 18 119 19 120 20 121 21 122 22 123 23 124 24 125 25 126 26 127 27 128 28 129 29 130 30 131 31 132 32 133 33 134 34 135 35 136 36 137 37 138 38 139 39 140 40 141 41 142 42 143 43 144 44 145 45 146 46 147 47 148 48 149 49 150 50 151 51 152 52 153 53 154 54 155 55 156 56 157 57 158 58 159 59 160 60 161 61 162 62 163 63 164 64 165 65 166 66 167 67 168 68 169 69 170 70 171 71 172 72 173 73 174 74 175 75 176 76 177 77 178 78 179 79 180 80 181 81 182 82 183 83 184 84 185 85 186 86 187 87 188 88 189 89 190 90 191 91 192 92 193 93 194 94 195 95 196 96 197 97 198 98 199 99 200 100
            """, "output": "NO"},
            {"input": """
1000
2500000999 2500001000 2500000997 2500000998 2500000995 2500000996 2500000993 2500000994 2500000991 2500000992 2500000989 2500000990 2500000987 2500000988 2500000985 2500000986 2500000983 2500000984 2500000981 2500000982 2500000979 2500000980 2500000977 2500000978 2500000975 2500000976 2500000973 2500000974 2500000971 2500000972 2500000969 2500000970 2500000967 2500000968 2500000965 2500000966 2500000963 2500000964 2500000961 2500000962 2500000959 2500000960 2500000957 2500000958 2500000955 2500000956 2500000953 2500000954 2500000951 2500000952 2500000949 2500000950 2500000947 2500000948 2500000945 2500000946 2500000943 2500000944 2500000941 2500000942 2500000939 2500000940 2500000937 2500000938 2500000935 2500000936 2500000933 2500000934 2500000931 2500000932 2500000929 2500000930 2500000927 2500000928 2500000925 2500000926 2500000923 2500000924 2500000921 2500000922 2500000919 2500000920 2500000917 2500000918 2500000915 2500000916 2500000913 2500000914 2500000911 2500000912 2500000909 2500000910 2500000907 2500000908 2500000905 2500000906 2500000903 2500000904 2500000901 2500000902 2500000899 2500000900 2500000897 2500000898 2500000895 2500000896 2500000893 2500000894 2500000891 2500000892 2500000889 2500000890 2500000887 2500000888 2500000885 2500000886 2500000883 2500000884 2500000881 2500000882 2500000879 2500000880 2500000877 2500000878 2500000875 2500000876 2500000873 2500000874 2500000871 2500000872 2500000869 2500000870 2500000867 2500000868 2500000865 2500000866 2500000863 2500000864 2500000861 2500000862 2500000859 2500000860 2500000857 2500000858 2500000855 2500000856 2500000853 2500000854 2500000851 2500000852 2500000849 2500000850 2500000847 2500000848 2500000845 2500000846 2500000843 2500000844 2500000841 2500000842 2500000839 2500000840 2500000837 2500000838 2500000835 2500000836 2500000833 2500000834 2500000831 2500000832 2500000829 2500000830 2500000827 2500000828 2500000825 2500000826 2500000823 2500000824 2500000821 2500000822 2500000819 2500000820 2500000817 2500000818 2500000815 2500000816 2500000813 2500000814 2500000811 2500000812 2500000809 2500000810 2500000807 2500000808 2500000805 2500000806 2500000803 2500000804 2500000801 2500000802 2500000799 2500000800 2500000797 2500000798 2500000795 2500000796 2500000793 2500000794 2500000791 2500000792 2500000789 2500000790 2500000787 2500000788 2500000785 2500000786 2500000783 2500000784 2500000781 2500000782 2500000779 2500000780 2500000777 2500000778 2500000775 2500000776 2500000773 2500000774 2500000771 2500000772 2500000769 2500000770 2500000767 2500000768 2500000765 2500000766 2500000763 2500000764 2500000761 2500000762 2500000759 2500000760 2500000757 2500000758 2500000755 2500000756 2500000753 2500000754 2500000751 2500000752 2500000749 2500000750 2500000747 2500000748 2500000745 2500000746 2500000743 2500000744 2500000741 2500000742 2500000739 2500000740 2500000737 2500000738 2500000735 2500000736 2500000733 2500000734 2500000731 2500000732 2500000729 2500000730 2500000727 2500000728 2500000725 2500000726 2500000723 2500000724 2500000721 2500000722 2500000719 2500000720 2500000717 2500000718 2500000715 2500000716 2500000713 2500000714 2500000711 2500000712 2500000709 2500000710 2500000707 2500000708 2500000705 2500000706 2500000703 2500000704 2500000701 2500000702 2500000699 2500000700 2500000697 2500000698 2500000695 2500000696 2500000693 2500000694 2500000691 2500000692 2500000689 2500000690 2500000687 2500000688 2500000685 2500000686 2500000683 2500000684 2500000681 2500000682 2500000679 2500000680 2500000677 2500000678 2500000675 2500000676 2500000673 2500000674 2500000671 2500000672 2500000669 2500000670 2500000667 2500000668 2500000665 2500000666 2500000663 2500000664 2500000661 2500000662 2500000659 2500000660 2500000657 2500000658 2500000655 2500000656 2500000653 2500000654 2500000651 2500000652 2500000649 2500000650 2500000647 2500000648 2500000645 2500000646 2500000643 2500000644 2500000641 2500000642 2500000639 2500000640 2500000637 2500000638 2500000635 2500000636 2500000633 2500000634 2500000631 2500000632 2500000629 2500000630 2500000627 2500000628 2500000625 2500000626 2500000623 2500000624 2500000621 2500000622 2500000619 2500000620 2500000617 2500000618 2500000615 2500000616 2500000613 2500000614 2500000611 2500000612 2500000609 2500000610 2500000607 2500000608 2500000605 2500000606 2500000603 2500000604 2500000601 2500000602 2500000599 2500000600 2500000597 2500000598 2500000595 2500000596 2500000593 2500000594 2500000591 2500000592 2500000589 2500000590 2500000587 2500000588 2500000585 2500000586 2500000583 2500000584 2500000581 2500000582 2500000579 2500000580 2500000577 2500000578 2500000575 2500000576 2500000573 2500000574 2500000571 2500000572 2500000569 2500000570 2500000567 2500000568 2500000565 2500000566 2500000563 2500000564 2500000561 2500000562 2500000559 2500000560 2500000557 2500000558 2500000555 2500000556 2500000553 2500000554 2500000551 2500000552 2500000549 2500000550 2500000547 2500000548 2500000545 2500000546 2500000543 2500000544 2500000541 2500000542 2500000539 2500000540 2500000537 2500000538 2500000535 2500000536 2500000533 2500000534 2500000531 2500000532 2500000529 2500000530 2500000527 2500000528 2500000525 2500000526 2500000523 2500000524 2500000521 2500000522 2500000519 2500000520 2500000517 2500000518 2500000515 2500000516 2500000513 2500000514 2500000511 2500000512 2500000509 2500000510 2500000507 2500000508 2500000505 2500000506 2500000503 2500000504 2500000501 2500000502 2500000499 2500000500 2500000497 2500000498 2500000495 2500000496 2500000493 2500000494 2500000491 2500000492 2500000489 2500000490 2500000487 2500000488 2500000485 2500000486 2500000483 2500000484 2500000481 2500000482 2500000479 2500000480 2500000477 2500000478 2500000475 2500000476 2500000473 2500000474 2500000471 2500000472 2500000469 2500000470 2500000467 2500000468 2500000465 2500000466 2500000463 2500000464 2500000461 2500000462 2500000459 2500000460 2500000457 2500000458 2500000455 2500000456 2500000453 2500000454 2500000451 2500000452 2500000449 2500000450 2500000447 2500000448 2500000445 2500000446 2500000443 2500000444 2500000441 2500000442 2500000439 2500000440 2500000437 2500000438 2500000435 2500000436 2500000433 2500000434 2500000431 2500000432 2500000429 2500000430 2500000427 2500000428 2500000425 2500000426 2500000423 2500000424 2500000421 2500000422 2500000419 2500000420 2500000417 2500000418 2500000415 2500000416 2500000413 2500000414 2500000411 2500000412 2500000409 2500000410 2500000407 2500000408 2500000405 2500000406 2500000403 2500000404 2500000401 2500000402 2500000399 2500000400 2500000397 2500000398 2500000395 2500000396 2500000393 2500000394 2500000391 2500000392 2500000389 2500000390 2500000387 2500000388 2500000385 2500000386 2500000383 2500000384 2500000381 2500000382 2500000379 2500000380 2500000377 2500000378 2500000375 2500000376 2500000373 2500000374 2500000371 2500000372 2500000369 2500000370 2500000367 2500000368 2500000365 2500000366 2500000363 2500000364 2500000361 2500000362 2500000359 2500000360 2500000357 2500000358 2500000355 2500000356 2500000353 2500000354 2500000351 2500000352 2500000349 2500000350 2500000347 2500000348 2500000345 2500000346 2500000343 2500000344 2500000341 2500000342 2500000339 2500000340 2500000337 2500000338 2500000335 2500000336 2500000333 2500000334 2500000331 2500000332 2500000329 2500000330 2500000327 2500000328 2500000325 2500000326 2500000323 2500000324 2500000321 2500000322 2500000319 2500000320 2500000317 2500000318 2500000315 2500000316 2500000313 2500000314 2500000311 2500000312 2500000309 2500000310 2500000307 2500000308 2500000305 2500000306 2500000303 2500000304 2500000301 2500000302 2500000299 2500000300 2500000297 2500000298 2500000295 2500000296 2500000293 2500000294 2500000291 2500000292 2500000289 2500000290 2500000287 2500000288 2500000285 2500000286 2500000283 2500000284 2500000281 2500000282 2500000279 2500000280 2500000277 2500000278 2500000275 2500000276 2500000273 2500000274 2500000271 2500000272 2500000269 2500000270 2500000267 2500000268 2500000265 2500000266 2500000263 2500000264 2500000261 2500000262 2500000259 2500000260 2500000257 2500000258 2500000255 2500000256 2500000253 2500000254 2500000251 2500000252 2500000249 2500000250 2500000247 2500000248 2500000245 2500000246 2500000243 2500000244 2500000241 2500000242 2500000239 2500000240 2500000237 2500000238 2500000235 2500000236 2500000233 2500000234 2500000231 2500000232 2500000229 2500000230 2500000227 2500000228 2500000225 2500000226 2500000223 2500000224 2500000221 2500000222 2500000219 2500000220 2500000217 2500000218 2500000215 2500000216 2500000213 2500000214 2500000211 2500000212 2500000209 2500000210 2500000207 2500000208 2500000205 2500000206 2500000203 2500000204 2500000201 2500000202 2500000199 2500000200 2500000197 2500000198 2500000195 2500000196 2500000193 2500000194 2500000191 2500000192 2500000189 2500000190 2500000187 2500000188 2500000185 2500000186 2500000183 2500000184 2500000181 2500000182 2500000179 2500000180 2500000177 2500000178 2500000175 2500000176 2500000173 2500000174 2500000171 2500000172 2500000169 2500000170 2500000167 2500000168 2500000165 2500000166 2500000163 2500000164 2500000161 2500000162 2500000159 2500000160 2500000157 2500000158 2500000155 2500000156 2500000153 2500000154 2500000151 2500000152 2500000149 2500000150 2500000147 2500000148 2500000145 2500000146 2500000143 2500000144 2500000141 2500000142 2500000139 2500000140 2500000137 2500000138 2500000135 2500000136 2500000133 2500000134 2500000131 2500000132 2500000129 2500000130 2500000127 2500000128 2500000125 2500000126 2500000123 2500000124 2500000121 2500000122 2500000119 2500000120 2500000117 2500000118 2500000115 2500000116 2500000113 2500000114 2500000111 2500000112 2500000109 2500000110 2500000107 2500000108 2500000105 2500000106 2500000103 2500000104 2500000101 2500000102 2500000099 2500000100 2500000097 2500000098 2500000095 2500000096 2500000093 2500000094 2500000091 2500000092 2500000089 2500000090 2500000087 2500000088 2500000085 2500000086 2500000083 2500000084 2500000081 2500000082 2500000079 2500000080 2500000077 2500000078 2500000075 2500000076 2500000073 2500000074 2500000071 2500000072 2500000069 2500000070 2500000067 2500000068 2500000065 2500000066 2500000063 2500000064 2500000061 2500000062 2500000059 2500000060 2500000057 2500000058 2500000055 2500000056 2500000053 2500000054 2500000051 2500000052 2500000049 2500000050 2500000047 2500000048 2500000045 2500000046 2500000043 2500000044 2500000041 2500000042 2500000039 2500000040 2500000037 2500000038 2500000035 2500000036 2500000033 2500000034 2500000031 2500000032 2500000029 2500000030 2500000027 2500000028 2500000025 2500000026 2500000023 2500000024 2500000021 2500000022 2500000019 2500000020 2500000017 2500000018 2500000015 2500000016 2500000013 2500000014 2500000011 2500000012 2500000009 2500000010 2500000007 2500000008 2500000005 2500000006 2500000003 2500000004 2500000001 2500000002
            """, "output": "YES"},
            {"input": """
1000
2500001000 2500000999 2500000997 2500000998 2500000995 2500000996 2500000993 2500000994 2500000991 2500000992 2500000989 2500000990 2500000987 2500000988 2500000985 2500000986 2500000983 2500000984 2500000981 2500000982 2500000979 2500000980 2500000977 2500000978 2500000975 2500000976 2500000973 2500000974 2500000971 2500000972 2500000969 2500000970 2500000967 2500000968 2500000965 2500000966 2500000963 2500000964 2500000961 2500000962 2500000959 2500000960 2500000957 2500000958 2500000955 2500000956 2500000953 2500000954 2500000951 2500000952 2500000949 2500000950 2500000947 2500000948 2500000945 2500000946 2500000943 2500000944 2500000941 2500000942 2500000939 2500000940 2500000937 2500000938 2500000935 2500000936 2500000933 2500000934 2500000931 2500000932 2500000929 2500000930 2500000927 2500000928 2500000925 2500000926 2500000923 2500000924 2500000921 2500000922 2500000919 2500000920 2500000917 2500000918 2500000915 2500000916 2500000913 2500000914 2500000911 2500000912 2500000909 2500000910 2500000907 2500000908 2500000905 2500000906 2500000903 2500000904 2500000901 2500000902 2500000899 2500000900 2500000897 2500000898 2500000895 2500000896 2500000893 2500000894 2500000891 2500000892 2500000889 2500000890 2500000887 2500000888 2500000885 2500000886 2500000883 2500000884 2500000881 2500000882 2500000879 2500000880 2500000877 2500000878 2500000875 2500000876 2500000873 2500000874 2500000871 2500000872 2500000869 2500000870 2500000867 2500000868 2500000865 2500000866 2500000863 2500000864 2500000861 2500000862 2500000859 2500000860 2500000857 2500000858 2500000855 2500000856 2500000853 2500000854 2500000851 2500000852 2500000849 2500000850 2500000847 2500000848 2500000845 2500000846 2500000843 2500000844 2500000841 2500000842 2500000839 2500000840 2500000837 2500000838 2500000835 2500000836 2500000833 2500000834 2500000831 2500000832 2500000829 2500000830 2500000827 2500000828 2500000825 2500000826 2500000823 2500000824 2500000821 2500000822 2500000819 2500000820 2500000817 2500000818 2500000815 2500000816 2500000813 2500000814 2500000811 2500000812 2500000809 2500000810 2500000807 2500000808 2500000805 2500000806 2500000803 2500000804 2500000801 2500000802 2500000799 2500000800 2500000797 2500000798 2500000795 2500000796 2500000793 2500000794 2500000791 2500000792 2500000789 2500000790 2500000787 2500000788 2500000785 2500000786 2500000783 2500000784 2500000781 2500000782 2500000779 2500000780 2500000777 2500000778 2500000775 2500000776 2500000773 2500000774 2500000771 2500000772 2500000769 2500000770 2500000767 2500000768 2500000765 2500000766 2500000763 2500000764 2500000761 2500000762 2500000759 2500000760 2500000757 2500000758 2500000755 2500000756 2500000753 2500000754 2500000751 2500000752 2500000749 2500000750 2500000747 2500000748 2500000745 2500000746 2500000743 2500000744 2500000741 2500000742 2500000739 2500000740 2500000737 2500000738 2500000735 2500000736 2500000733 2500000734 2500000731 2500000732 2500000729 2500000730 2500000727 2500000728 2500000725 2500000726 2500000723 2500000724 2500000721 2500000722 2500000719 2500000720 2500000717 2500000718 2500000715 2500000716 2500000713 2500000714 2500000711 2500000712 2500000709 2500000710 2500000707 2500000708 2500000705 2500000706 2500000703 2500000704 2500000701 2500000702 2500000699 2500000700 2500000697 2500000698 2500000695 2500000696 2500000693 2500000694 2500000691 2500000692 2500000689 2500000690 2500000687 2500000688 2500000685 2500000686 2500000683 2500000684 2500000681 2500000682 2500000679 2500000680 2500000677 2500000678 2500000675 2500000676 2500000673 2500000674 2500000671 2500000672 2500000669 2500000670 2500000667 2500000668 2500000665 2500000666 2500000663 2500000664 2500000661 2500000662 2500000659 2500000660 2500000657 2500000658 2500000655 2500000656 2500000653 2500000654 2500000651 2500000652 2500000649 2500000650 2500000647 2500000648 2500000645 2500000646 2500000643 2500000644 2500000641 2500000642 2500000639 2500000640 2500000637 2500000638 2500000635 2500000636 2500000633 2500000634 2500000631 2500000632 2500000629 2500000630 2500000627 2500000628 2500000625 2500000626 2500000623 2500000624 2500000621 2500000622 2500000619 2500000620 2500000617 2500000618 2500000615 2500000616 2500000613 2500000614 2500000611 2500000612 2500000609 2500000610 2500000607 2500000608 2500000605 2500000606 2500000603 2500000604 2500000601 2500000602 2500000599 2500000600 2500000597 2500000598 2500000595 2500000596 2500000593 2500000594 2500000591 2500000592 2500000589 2500000590 2500000587 2500000588 2500000585 2500000586 2500000583 2500000584 2500000581 2500000582 2500000579 2500000580 2500000577 2500000578 2500000575 2500000576 2500000573 2500000574 2500000571 2500000572 2500000569 2500000570 2500000567 2500000568 2500000565 2500000566 2500000563 2500000564 2500000561 2500000562 2500000559 2500000560 2500000557 2500000558 2500000555 2500000556 2500000553 2500000554 2500000551 2500000552 2500000549 2500000550 2500000547 2500000548 2500000545 2500000546 2500000543 2500000544 2500000541 2500000542 2500000539 2500000540 2500000537 2500000538 2500000535 2500000536 2500000533 2500000534 2500000531 2500000532 2500000529 2500000530 2500000527 2500000528 2500000525 2500000526 2500000523 2500000524 2500000521 2500000522 2500000519 2500000520 2500000517 2500000518 2500000515 2500000516 2500000513 2500000514 2500000511 2500000512 2500000509 2500000510 2500000507 2500000508 2500000505 2500000506 2500000503 2500000504 2500000501 2500000502 2500000499 2500000500 2500000497 2500000498 2500000495 2500000496 2500000493 2500000494 2500000491 2500000492 2500000489 2500000490 2500000487 2500000488 2500000485 2500000486 2500000483 2500000484 2500000481 2500000482 2500000479 2500000480 2500000477 2500000478 2500000475 2500000476 2500000473 2500000474 2500000471 2500000472 2500000469 2500000470 2500000467 2500000468 2500000465 2500000466 2500000463 2500000464 2500000461 2500000462 2500000459 2500000460 2500000457 2500000458 2500000455 2500000456 2500000453 2500000454 2500000451 2500000452 2500000449 2500000450 2500000447 2500000448 2500000445 2500000446 2500000443 2500000444 2500000441 2500000442 2500000439 2500000440 2500000437 2500000438 2500000435 2500000436 2500000433 2500000434 2500000431 2500000432 2500000429 2500000430 2500000427 2500000428 2500000425 2500000426 2500000423 2500000424 2500000421 2500000422 2500000419 2500000420 2500000417 2500000418 2500000415 2500000416 2500000413 2500000414 2500000411 2500000412 2500000409 2500000410 2500000407 2500000408 2500000405 2500000406 2500000403 2500000404 2500000401 2500000402 2500000399 2500000400 2500000397 2500000398 2500000395 2500000396 2500000393 2500000394 2500000391 2500000392 2500000389 2500000390 2500000387 2500000388 2500000385 2500000386 2500000383 2500000384 2500000381 2500000382 2500000379 2500000380 2500000377 2500000378 2500000375 2500000376 2500000373 2500000374 2500000371 2500000372 2500000369 2500000370 2500000367 2500000368 2500000365 2500000366 2500000363 2500000364 2500000361 2500000362 2500000359 2500000360 2500000357 2500000358 2500000355 2500000356 2500000353 2500000354 2500000351 2500000352 2500000349 2500000350 2500000347 2500000348 2500000345 2500000346 2500000343 2500000344 2500000341 2500000342 2500000339 2500000340 2500000337 2500000338 2500000335 2500000336 2500000333 2500000334 2500000331 2500000332 2500000329 2500000330 2500000327 2500000328 2500000325 2500000326 2500000323 2500000324 2500000321 2500000322 2500000319 2500000320 2500000317 2500000318 2500000315 2500000316 2500000313 2500000314 2500000311 2500000312 2500000309 2500000310 2500000307 2500000308 2500000305 2500000306 2500000303 2500000304 2500000301 2500000302 2500000299 2500000300 2500000297 2500000298 2500000295 2500000296 2500000293 2500000294 2500000291 2500000292 2500000289 2500000290 2500000287 2500000288 2500000285 2500000286 2500000283 2500000284 2500000281 2500000282 2500000279 2500000280 2500000277 2500000278 2500000275 2500000276 2500000273 2500000274 2500000271 2500000272 2500000269 2500000270 2500000267 2500000268 2500000265 2500000266 2500000263 2500000264 2500000261 2500000262 2500000259 2500000260 2500000257 2500000258 2500000255 2500000256 2500000253 2500000254 2500000251 2500000252 2500000249 2500000250 2500000247 2500000248 2500000245 2500000246 2500000243 2500000244 2500000241 2500000242 2500000239 2500000240 2500000237 2500000238 2500000235 2500000236 2500000233 2500000234 2500000231 2500000232 2500000229 2500000230 2500000227 2500000228 2500000225 2500000226 2500000223 2500000224 2500000221 2500000222 2500000219 2500000220 2500000217 2500000218 2500000215 2500000216 2500000213 2500000214 2500000211 2500000212 2500000209 2500000210 2500000207 2500000208 2500000205 2500000206 2500000203 2500000204 2500000201 2500000202 2500000199 2500000200 2500000197 2500000198 2500000195 2500000196 2500000193 2500000194 2500000191 2500000192 2500000189 2500000190 2500000187 2500000188 2500000185 2500000186 2500000183 2500000184 2500000181 2500000182 2500000179 2500000180 2500000177 2500000178 2500000175 2500000176 2500000173 2500000174 2500000171 2500000172 2500000169 2500000170 2500000167 2500000168 2500000165 2500000166 2500000163 2500000164 2500000161 2500000162 2500000159 2500000160 2500000157 2500000158 2500000155 2500000156 2500000153 2500000154 2500000151 2500000152 2500000149 2500000150 2500000147 2500000148 2500000145 2500000146 2500000143 2500000144 2500000141 2500000142 2500000139 2500000140 2500000137 2500000138 2500000135 2500000136 2500000133 2500000134 2500000131 2500000132 2500000129 2500000130 2500000127 2500000128 2500000125 2500000126 2500000123 2500000124 2500000121 2500000122 2500000119 2500000120 2500000117 2500000118 2500000115 2500000116 2500000113 2500000114 2500000111 2500000112 2500000109 2500000110 2500000107 2500000108 2500000105 2500000106 2500000103 2500000104 2500000101 2500000102 2500000099 2500000100 2500000097 2500000098 2500000095 2500000096 2500000093 2500000094 2500000091 2500000092 2500000089 2500000090 2500000087 2500000088 2500000085 2500000086 2500000083 2500000084 2500000081 2500000082 2500000079 2500000080 2500000077 2500000078 2500000075 2500000076 2500000073 2500000074 2500000071 2500000072 2500000069 2500000070 2500000067 2500000068 2500000065 2500000066 2500000063 2500000064 2500000061 2500000062 2500000059 2500000060 2500000057 2500000058 2500000055 2500000056 2500000053 2500000054 2500000051 2500000052 2500000049 2500000050 2500000047 2500000048 2500000045 2500000046 2500000043 2500000044 2500000041 2500000042 2500000039 2500000040 2500000037 2500000038 2500000035 2500000036 2500000033 2500000034 2500000031 2500000032 2500000029 2500000030 2500000027 2500000028 2500000025 2500000026 2500000023 2500000024 2500000021 2500000022 2500000019 2500000020 2500000017 2500000018 2500000015 2500000016 2500000013 2500000014 2500000011 2500000012 2500000009 2500000010 2500000007 2500000008 2500000005 2500000006 2500000003 2500000004 2500000001 2500000002
            """, "output": "NO"},
        ]
    }
]

@app.post("/submit/")
async def submit_code(
    username: str = Form(...),
    problem_id: int = Form(...),
    code: UploadFile = Form(...)
):
    task = next((t for t in tasks if t["id"] == problem_id), None)
    if not task:
        return {"status": "error", "message": "Задача не найдена"}

    # Создаём временный файл для кода
    content = await code.read()
    with tempfile.NamedTemporaryFile(delete=False, suffix=".cpp") as tmp:
        code_path = tmp.name
        tmp.write(content)
    exe_path = code_path.replace(".cpp", "")

    # Компиляция
    compile_proc = subprocess.run(
        ["g++", code_path, "-o", exe_path],
        capture_output=True, text=True
    )
    if compile_proc.returncode != 0:
        os.remove(code_path)
        return JSONResponse({"status":"compile_error", "message": compile_proc.stderr})

    # Запуск тестов
    passed = 0
    total = len(task["tests"])
    for t in task["tests"]:
        try:
            run_proc = subprocess.run(
                exe_path,
                input=t["input"],
                text=True,
                capture_output=True,
                timeout=3
            )
            output = run_proc.stdout.strip()
            if output == t["output"].strip():
                passed += 1
        except subprocess.TimeoutExpired:
            continue

    score = int((passed / total) * 100)

    # Сохраняем результат в БД
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("INSERT OR IGNORE INTO users(username) VALUES (?)", (username,))
    cur.execute("SELECT id FROM users WHERE username = ?", (username,))
    user_id = cur.fetchone()["id"]

    # Проверяем, решал ли уже задачу на 100%
    cur.execute(
        "SELECT COUNT(*) as cnt FROM submissions WHERE user_id = ? AND problem_id = ? AND score = 100",
        (user_id, problem_id)
    )
    already_solved = cur.fetchone()["cnt"] > 0

    # Вставляем новое решение
    cur.execute(
        "INSERT INTO submissions(user_id, problem_id, code, score) VALUES (?,?,?,?)",
        (user_id, problem_id, content.decode(), score)
    )

    # Увеличиваем solved_count только если ещё не решал задачу на 100%
    if score == 100 and not already_solved:
        cur.execute("UPDATE users SET solved_count = solved_count + 1 WHERE id = ?", (user_id,))

    conn.commit()
    conn.close()

    # Удаляем временные файлы
    os.remove(code_path)
    if os.path.exists(exe_path):
        os.remove(exe_path)

    return {
        "status": "success",
        "score": score,
        "passed": passed,
        "total": total
    }

@app.get("/leaderboard/")
def leaderboard():
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("SELECT username, solved_count FROM users ORDER BY solved_count DESC LIMIT 10")
    data = [dict(row) for row in cur.fetchall()]
    conn.close()
    return data

@app.get("/tasks/")
def get_tasks():
    return [{"id": t["id"], "title": t["title"], "description": t["description"]} for t in tasks]
#sqlite3 database.db

#python -m uvicorn backend.main:app --reload
