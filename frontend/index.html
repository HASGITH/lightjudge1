<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LightJudge</title>
  <link rel="stylesheet" href="/frontend/style.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="container">
    <div class="header" style="grid-column:1/-1">
      <div class="brand">LightJudge</div>
      <div class="footer-note">A simple online problem tester — a fast UI for your contests</div>
    </div>

    <aside class="card">
      <h3>Problems</h3>
      <div id="taskList" class="task-list" aria-live="polite"></div>
    </aside>

    <main class="card task-detail" id="taskDetail" aria-live="polite">
      <h2 id="taskTitle">Select a problem</h2>
      <pre id="taskDesc" style="white-space:pre-wrap;color:var(--muted);min-height:120px"></pre>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="username" placeholder="Username" style="padding:8px;border-radius:6px;border:1px solid #e6eefc;width:220px" />
        <select id="problemSelect" aria-label="Select a problem" style="padding:8px;border-radius:6px;border:1px solid #e6eefc">
          <option value="">Select a problem</option>
        </select>
        <button id="fillExample" class="btn ghost">Code example</button>
      </div>

      <div style="margin-top:12px">
        <label style="display:block;margin-bottom:6px;font-weight:600">Code (C++)</label>
        <textarea id="code" rows="12" style="width:100%;padding:12px;border-radius:10px;border:1px solid #e6eefc;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "consolas", "Liberation Mono", monospace;"></textarea>
      </div>

      <div class="controls" style="margin-top:12px">
        <button id="submitBtn" class="btn">Submit</button>
        <button id="downloadBtn" class="btn ghost">Download .cpp</button>
      </div>

      <div style="margin-top:14px">
        <div class="progress" aria-hidden="true"><i id="progressBar" style="width:0%"></i></div>
        <div id="result" style="margin-top:10px"></div>
      </div>
    </main>

    <aside class="card right-col">
      <h3>Leaderboard</h3>
      <ul id="leaderboard" class="leaderboard" aria-live="polite"></ul>

      <h4 style="margin-top:14px">Last submitions</h4>
      <div id="subs" style="font-size:13px;color:var(--muted);max-height:36vh;overflow:auto"></div>
    </aside>
  </div>

  <script>
    // API_BASE оставляем пустым чтобы использовать тот же хост/порт
    const API_BASE = "";

    async function loadTasks() {
      try {
        const res = await fetch(API_BASE + "/tasks/");
        const tasks = await res.json();
        window._tasks = tasks;
        const list = document.getElementById("taskList");
        const select = document.getElementById("problemSelect");
        list.innerHTML = ""; select.innerHTML = "<option value=''>Select a problem</option>";
        tasks.forEach(t => {
          const item = document.createElement("div");
          item.className = "task-item";
          item.tabIndex = 0;
          item.innerHTML = `<h4>${t.id}. ${t.title}</h4><p>${t.description ? t.description.slice(0,160) : ""}</p>`;
          item.onclick = () => selectTask(t.id);
          item.onkeypress = (e) => { if (e.key === "Enter") selectTask(t.id); };
          list.appendChild(item);

          const opt = document.createElement("option");
          opt.value = t.id; opt.textContent = `${t.id}. ${t.title}`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Error loading problems:", err);
        document.getElementById("taskList").textContent = "Failed to load problems";
      }
    }

    function selectTask(id) {
      const t = (window._tasks || []).find(x => x.id == id);
      if (!t) return;
      document.getElementById("taskTitle").textContent = `${t.id}. ${t.title}`;
      document.getElementById("taskDesc").textContent = t.description || "(Description not available)";
      document.getElementById("problemSelect").value = id;
    }

    document.getElementById("fillExample").onclick = () => {
      document.getElementById("code").value =
`#include <bits/stdc++.h>
using namespace std;
int main() {
  long long a, b;
  if(!(cin >> a >> b)) return 0;
  cout << (a + b);
  return 0;
}
`;
    };

    async function loadLeaderboard() {
      try {
        const res = await fetch(API_BASE + "/leaderboard/");
        const data = await res.json();
        const list = document.getElementById("leaderboard");
        list.innerHTML = "";
        data.forEach(u => {
          const li = document.createElement("li");
          li.textContent = `${u.username}: ${u.solved_count}`;
          list.appendChild(li);
        });
      } catch (err) {
        console.error("Error loading leaderboard:", err);
        document.getElementById("leaderboard").textContent = "Failed to load";
      }
    }

    document.getElementById("submitBtn").onclick = async () => {
      const username = document.getElementById("username").value.trim();
      const problem_id = document.getElementById("problemSelect").value;
      const code = document.getElementById("code").value;
      if (!username) { alert("Enter username"); return; }
      if (!problem_id) { alert("Select a problem"); return; }
      if (!code.trim()) { alert("Code is empty"); return; }

      const form = new FormData();
      form.append("username", username);
      form.append("problem_id", problem_id);
      const blob = new Blob([code], { type: "text/x-c++src" });
      form.append("code", blob, "solution.cpp");

      const progressBar = document.getElementById("progressBar");
      const result = document.getElementById("result");
      progressBar.style.width = "10%";
      result.innerHTML = "Submitting...";

      try {
        const res = await fetch(API_BASE + "/submit/", { method: "POST", body: form });
        const data = await res.json();
        if (data.status === "success") {
          progressBar.style.width = "100%";
          result.innerHTML = `Result: <strong>${data.score}%</strong> (${data.passed}/${data.total})`;
          appendSubmission(username, problem_id, data.score);
        } else if (data.status === "compile_error") {
          progressBar.style.width = "0%";
          result.innerHTML = `<div style="color:var(--danger);font-weight:600">Compilation Error</div><pre style="white-space:pre-wrap;color:var(--muted)">${escapeHtml(data.message)}</pre>`;
        } else {
          progressBar.style.width = "0%";
          result.textContent = JSON.stringify(data);
        }
      } catch (err) {
        console.error("Failed to submit solution:", err);
        progressBar.style.width = "0%";
        result.textContent = "Network error while submitting";
      } finally {
        await loadLeaderboard();
      }
    };

    document.getElementById("downloadBtn").onclick = () => {
      const code = document.getElementById("code").value;
      const blob = new Blob([code], { type: "text/x-c++src" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "solution.cpp";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    function appendSubmission(username, problemId, score) {
      const subs = document.getElementById("subs");
      const entry = document.createElement("div");
      const time = new Date().toLocaleTimeString();
      entry.innerHTML = `<strong>${username}</strong> — #${problemId} — ${score}% <span style="color:var(--muted);font-size:12px">(${time})</span>`;
      subs.prepend(entry);
      if (subs.children.length > 50) subs.removeChild(subs.lastChild);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, function (m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }

    // Инициализация
    loadTasks();
    loadLeaderboard();
  </script>
</body>
</html>

