<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LightJudge</title>
</head>
<body>
  <h1>LightJudge</h1>

  <h2>Список задач</h2>
  <ul id="taskList"></ul>

  <h2>Отправка решения</h2>
  <form id="submitForm">
    <input type="text" name="username" placeholder="Username" required>
    <select name="problem_id" id="problemSelect" required></select>
    <input type="file" name="code" required>
    <button type="submit">Submit</button>
  </form>

  <h2>Leaderboard</h2>
  <ul id="leaderboard"></ul>

  <script>
    const API_BASE = ""; // пусто, так как фронтенд и бэкенд на одном домене

    // Загружаем задачи с сервера
    async function loadTasks() {
      try {
        const res = await fetch(API_BASE + "/tasks/");
        const tasks = await res.json();
        const list = document.getElementById("taskList");
        const select = document.getElementById("problemSelect");
        list.innerHTML = "";
        select.innerHTML = "";

        tasks.forEach(t => {
          // Список задач
          const li = document.createElement("li");
          const title = document.createElement("h3");
          title.textContent = `${t.id}. ${t.title}`;
          li.appendChild(title);

          const desc = document.createElement("pre");
          desc.textContent = t.description;
          li.appendChild(desc);

          list.appendChild(li);

          // Выпадающий список для отправки решения
          const option = document.createElement("option");
          option.value = t.id;
          option.textContent = `${t.id}. ${t.title}`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Ошибка загрузки задач:", err);
      }
    }

    // Отправка кода
    document.getElementById("submitForm").onsubmit = async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);

      try {
        const res = await fetch(API_BASE + "/submit/", {
          method: "POST",
          body: form
        });
        const data = await res.json();

        if (data.status === "success") {
          alert(`Процент правильности: ${data.score}% (${data.passed}/${data.total})`);
        } else if (data.status === "compile_error") {
          alert("Ошибка компиляции:\n" + data.message);
        } else {
          alert(JSON.stringify(data));
        }
        loadLeaderboard();
      } catch (err) {
        console.error("Ошибка отправки решения:", err);
        alert("Ошибка отправки решения. Проверьте консоль.");
      }
    };

    // Загружаем таблицу лидеров
    async function loadLeaderboard() {
      try {
        const res = await fetch(API_BASE + "/leaderboard/");
        const data = await res.json();
        const list = document.getElementById("leaderboard");
        list.innerHTML = "";
        data.forEach(u => {
          const li = document.createElement("li");
          li.textContent = `${u.username}: ${u.solved_count}`;
          list.appendChild(li);
        });
      } catch (err) {
        console.error("Ошибка загрузки лидеров:", err);
      }
    }

    // Инициализация
    loadTasks();
    loadLeaderboard();
  </script>
</body>
</html>
